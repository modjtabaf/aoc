
#include <climits>
#include <iostream>
#include <vector>

using Diagram = std::vector<std::string>;

Diagram sample_diagram{
    ".......|.......",
    "...............",
    ".......^.......",
    "...............",
    "......^.^......",
    "...............",
    ".....^.^.^.....",
    "...............",
    "....^.^...^....",
    "...............",
    "...^.^...^.^...",
    "...............",
    "..^...^.....^..",
    "...............",
    ".^.^.^.^.^...^.",
    "...............",
};

Diagram diagram{
    "......................................................................|......................................................................",
    ".............................................................................................................................................",
    "......................................................................^......................................................................",
    ".............................................................................................................................................",
    ".....................................................................^.^.....................................................................",
    ".............................................................................................................................................",
    "....................................................................^.^.^....................................................................",
    ".............................................................................................................................................",
    "...................................................................^.....^...................................................................",
    ".............................................................................................................................................",
    "..................................................................^.^...^.^..................................................................",
    ".............................................................................................................................................",
    ".................................................................^.^.^...^.^.................................................................",
    ".............................................................................................................................................",
    "................................................................^.^...^.^.^.^................................................................",
    ".............................................................................................................................................",
    "...............................................................^.^.^.......^.^...............................................................",
    ".............................................................................................................................................",
    "..............................................................^.^...^...^.^.^.^..............................................................",
    ".............................................................................................................................................",
    ".............................................................^.^.^.^.^.^.....^.^.............................................................",
    ".............................................................................................................................................",
    "............................................................^.......^.^.^...^...^............................................................",
    ".............................................................................................................................................",
    "...........................................................^...^.^.^...^...^...^.^...........................................................",
    ".............................................................................................................................................",
    "..........................................................^.^.^.....^.......^...^.^..........................................................",
    ".............................................................................................................................................",
    ".........................................................^...^.^.^.^.....^.....^.^.^.........................................................",
    ".............................................................................................................................................",
    "........................................................^.......^.^.^.^.^.^.^.....^.^........................................................",
    ".............................................................................................................................................",
    ".......................................................^.^.^.^.....^.^.^.^.^.^.^.^...^.......................................................",
    ".............................................................................................................................................",
    "......................................................^.........^.^...^.^.^.^...^.^.^.^......................................................",
    ".............................................................................................................................................",
    ".....................................................^...^.^.^.^...^.^.^.^...^.^.^.^.^.^.....................................................",
    ".............................................................................................................................................",
    "....................................................^.^...^...^.^.^.^.^...^.^.^...^...^.^....................................................",
    ".............................................................................................................................................",
    "...................................................^.^...^.^...^.^.^.^.^.^.^.....^.^.....^...................................................",
    ".............................................................................................................................................",
    "..................................................^.....^.^.....^.^.^.......^.....^...^.^.^..................................................",
    ".............................................................................................................................................",
    ".................................................^...^.^...^.^.^.^...^.^.^.^.^.^.^...^.....^.................................................",
    ".............................................................................................................................................",
    "................................................^...^.^.^.^.^.^.^.^.......^...^.^.^.^...^...^................................................",
    ".............................................................................................................................................",
    "...............................................^.^...^.^...^...^.^.^.^...^.^.....^...^.^.^.^.^...............................................",
    ".............................................................................................................................................",
    "..............................................^...^.^...^...^.^...^.^.^.^...^.^...^.^.^...^.^.^..............................................",
    ".............................................................................................................................................",
    ".............................................^.^.........^.^.....^.^.^.^.^...^...^...^.....^...^.............................................",
    ".............................................................................................................................................",
    "............................................^.^.^...^.^...^...^.^.^.^.^.^.....^.^.^.....^.^...^.^............................................",
    ".............................................................................................................................................",
    "...........................................^...^.^.^.^.^.^...^...^...^.^.......^...^.^.^.^.^.^.^.^...........................................",
    ".............................................................................................................................................",
    "..........................................^.......^.^.^.^.^...^.^.^.^...^.^...^.^.^.....^...^.^...^..........................................",
    ".............................................................................................................................................",
    ".........................................^...^.^...^...^...^.^...^.^.^.^.^...^.....^...^...^.^.^...^.........................................",
    ".............................................................................................................................................",
    "........................................^.^.^.^.^.....^.^.^.....^...^.^.^.^.^.^.^.^...^.^...^...^...^........................................",
    ".............................................................................................................................................",
    ".......................................^...^.^...^.^.^...^.^...^.........^...^.^.....^.^...^.^.^.^...^.......................................",
    ".............................................................................................................................................",
    "......................................^...^...^.....^...^.......^.^...^...^.....^...........^.^.^.^.^.^......................................",
    ".............................................................................................................................................",
    ".....................................^...^.^.^.^.^.^.....^.^.^.^.^.^.....^...^.^.^.^...^.....^.^.^...^.^.....................................",
    ".............................................................................................................................................",
    "....................................^...........^...^.......^.^.^.^.........^.^.^...^.....^.^.^.^.......^....................................",
    ".............................................................................................................................................",
    "...................................^.^.^...^.^.^.....^.....^.^.^.^.^.^.^...^.^.^.^.^...^.^...^.^.^.^...^.^...................................",
    ".............................................................................................................................................",
    "..................................^...^.^...^.^.^.^.^.^.^.^.^.^.^.^.^.^.^.^.^...^.^.^...^...^.^.^.^.^.^.^.^..................................",
    ".............................................................................................................................................",
    ".................................^...^.^.^.^.^...^.^.^.^.^.^.^.^.^.^.^.^.^.^...^.^...^.^.^.^...^.^.......^.^.................................",
    ".............................................................................................................................................",
    "................................^.^.^.^.^...^.^.......^.^.^.^.^.^.....^.^.^...^.......^...^...^.^.^.....^...^................................",
    ".............................................................................................................................................",
    "...............................^.....^.^.......^.^...^.^...^.^.^...^...^.^.^.........^.^.^.^.^.....^...^...^.^...............................",
    ".............................................................................................................................................",
    "..............................^.^.^...^.....^.^...^.^.^.^.^.^.^.^.........^.^...^...^...^.^.^...^...^.^.^.....^..............................",
    ".............................................................................................................................................",
    ".............................^.^.....^.......^.^.^.^.^.^...^.....^.^.^.^...^.^.^...^.^.^.^.^.^...^.^.^.^...^.^.^.............................",
    ".............................................................................................................................................",
    "............................^.......^...^.^.^.....^...^.^.^.^.^.^.^...^...^.......^.^...^.^.^.^.........^.^...^.^............................",
    ".............................................................................................................................................",
    "...........................^...^...^.^.^.^...^.^...^...^.^...^.^.^.^.^.^.....^...^.^.....^.^.^.^...^.........^...^...........................",
    ".............................................................................................................................................",
    "..........................^.^.^.^.^.^.....^...^...^.^.^.....^...^.^.^...^.^.^.^.^.^.^.....^.^.^.^.^.^.^.^.....^...^..........................",
    ".............................................................................................................................................",
    ".........................^.^.^.......^.^.^.....^.^.^.^...^.^.^...^...^...^.^...^.^.....^.^.^.........^.....^.^.^...^.........................",
    ".............................................................................................................................................",
    "........................^.^.^.....^.^...^.^.......^.^.^.....^.^.^.......^.^.....^.^.^.^.^.^.^...^.....^.^.^.^.^.^...^........................",
    ".............................................................................................................................................",
    ".......................^.^.^.....^.^.........^.^.........^...^...^.^.....^.^.^.^.....^...^.^.^.^.^.....^.^.^...^.....^.......................",
    ".............................................................................................................................................",
    "......................^...^.^.^.....^.^.^...^.^.^.^.^...^...^...^.^.^.^...^.^...^.^.^.^.^...^.^...^...^.^.....^...^...^......................",
    ".............................................................................................................................................",
    ".....................^...^.^.^.....^.^.^...^.^.^...^.^.^.....^...^.......^.^.^.^...^.^.^.^.^.^.^.^...^.^.....^.^.^.^...^.....................",
    ".............................................................................................................................................",
    "....................^...^.^.^.....^...^...^.^...^...^...^.....^.^...^...^...^.......^...^.^...^.^...^.......^.^.......^.^....................",
    ".............................................................................................................................................",
    "...................^.^.^.............^.^.^...^.^.^.....^...^...^.^...^.^.^.^.^.................^.^.^.^.^.^.^.^.^.^...^.^.^...................",
    ".............................................................................................................................................",
    "..................^.^.....^.^.^.....^.^...^.^...^.^.^.^.^.^...^.^.^.^.^.^...^...^.^.^.^.......^.^.^.^.^.^.^.^.^.....^.^.^.^..................",
    ".............................................................................................................................................",
    ".................^.....^...^.....^...^.^.^...^...^.^...^...^.^.^...^.^.^.^...^...^.^.^.^.^...^.^.....^...^.^...^.^.......^.^.................",
    ".............................................................................................................................................",
    "................^.^...^...^.^.^...^.^.^.^.^.^.....^...^.^...^.^...^...^.^.....^...^...^.^...^...^...^...^.^...^.^.^.....^...^................",
    ".............................................................................................................................................",
    "...............^.^...^.^.^.^.^.^.^...^.^.^.^.^.^.^...^.....^.^.^.......^.....^.^.^.......^.....^.^...^.^...^...^.^.^.^.....^.^...............",
    ".............................................................................................................................................",
    "..............^.^.^...^.^.^.....^.^.^.......^...^.^...^.^.^...^.^.^.^.^.^.........^.^.^.^.^.^...^...^.^.......^...^.^.....^.^.^..............",
    ".............................................................................................................................................",
    ".............^...^.......^...^.^.^.^...^.^.......^.^.^.^.....^.^.^...^...^.....^.^...^.^...^.^...^.^.^.^...^.......^.^.....^.^.^.............",
    ".............................................................................................................................................",
    "............^.^.^...^...^...^.^.^...^.......^...^...^.....^.^.^...^...^.^...^.^.^.^...^.^...^.^.^...^.^.^...^.^.^.^.^.^.....^...^............",
    ".............................................................................................................................................",
    "...........^.^.^...^.......^.^.^.^.^.....^...^...^.^.^.^.....^...^...^...^.^.^.^.^.^.^.^.^.^.^.^...^.....^.^.^.^.^.^.^.^.^.^.^.^.^...........",
    ".............................................................................................................................................",
    "..........^.^.....^.^...^.....^...^.^.^...^.^.^.^.^...^...^.^...^.^.^...^.......^.^.^.^.^.^.......^.....^...^...^.^.......^...^...^..........",
    ".............................................................................................................................................",
    ".........^.^.....^.^.^.^.^.^.^...^...^.....^.^.^.....^.^.^.^.^.^...^...^...^.^.^...^.^.^.^.....^...^.^.^...^.^...^.^.........^.^.^.^.........",
    ".............................................................................................................................................",
    "........^.^.^.^.^.....^.^...^.^.^...^.^.^.^.......^...^...^.....^.^.....^.^.^...^.^.^...^.^...^.^...^.^.....^...^.....^.^.^.^.^.^...^........",
    ".............................................................................................................................................",
    ".......^.....^...^...^.....^.^.....^...^.^.^...^.^.....^.^.^.^.^...^...^.^.^.^.....^.^.^.^.^.^.^.^...^.^.^...^.^...^.^...^...^...^.^.^.......",
    ".............................................................................................................................................",
    "......^...^...^.......^...^.^...^.^.^.......^.^.^.^.^.....^.^.....^...^.^.^.........^...^...^.^.^...^.^...^.^.^.^.^...^.^.^.^.^.^.....^......",
    ".............................................................................................................................................",
    ".....^...^.^.^...^...^.^.......^.^.^.^.^.^.....^...^...^.^.^.^.^.^.^.......^...^.^...^.^.^.^.^...^.^.^.^.^.^...^.^.^.^.^.^...^.^.^.....^.....",
    ".............................................................................................................................................",
    "....^.........^.^.^...^.^...^.^.^.^...^.^.....^.^.^.^.....^.^.^.^.....^.^.^...^.....^.^.^...^.^.^.^.....^...^.......^.^...^.^.^...^.^...^....",
    ".............................................................................................................................................",
    "...^.......^...^.^.^.^...^.............^.^...^.^.^.^...^.^.^.^.^.^...^.^.^.^.^.^.....^...^.^.^.....^.^.^...^.^.^.^.^.........^.^.^.^.^.^.^...",
    ".............................................................................................................................................",
    "..^.^.^.^...^...^.^.^.^...^.^.......^...^.^.^.^.^.^.^.^.^...^.^...^.....^.^...^.^.........^.^...^.^.^.^.....^.^.^...^.....^.^.....^.^.^.^.^..",
    ".............................................................................................................................................",
    ".^...^.^.^.^...^.^.^.^.^.....^...^.....^.^.^...^...^.^.....^.^.^.^.^.^.^.^.^.^.^.^.^.^.........^.^.^.....^.^.^.^.^.^.^.^...^...^.^.^...^...^.",
    ".............................................................................................................................................",    
};

ulong part1(Diagram& diagram)
{
    ulong ret = 0;
    auto row1 = diagram.begin();
    for (auto row2 = row1 + 1; row2 != diagram.end(); ++row1, ++row2)
    {
        for (auto c1 = row1->begin(), c2 = row2->begin(); c1 != row1->end(); ++c1, ++c2)
        {
            if (*c1 != '|') continue;
            if (*c2 != '^')
            {
                *c2 = '|';
                continue;
            }
            if (c2 > row2->begin()) *(c2 - 1) = '|';
            if (c2 + 1 < row2->end()) *(c2 + 1) = '|';
            ++ret;
        }
    }
    return ret;
}

ulong part2(const Diagram& diagram)
{
    ulong nrows = diagram.size();
    ulong ncols = diagram[0].size();
    std::vector<std::vector<ulong>> counts;
    counts.reserve(nrows);
    for (ulong row = 0 ; row  < nrows; ++row)
        counts.emplace_back(ncols);

    auto diag_row = diagram.begin();
    for (auto& row: counts)
    {
        auto diag_c = diag_row->begin();
        for (auto& c: row)
        {
            if (*diag_c == '.') c = 0;
            else if (*diag_c == '|') c = 1;
            else if (*diag_c == '^') c = UINT_MAX;
            ++diag_c;
        }
        ++diag_row;
    }

    auto row1 = counts.begin();
    for (auto row2 = row1 + 1; row2 != counts.end(); ++row1, ++row2)
    {
        for (auto c1 = row1->begin(), c2 = row2->begin(); c1 != row1->end(); ++c1, ++c2)
        {
            if (*c1 == 0 || *c1 == UINT_MAX) continue;
            if (*c2 != UINT_MAX)
            {
                *c2 += *c1;
                continue;
            }
            if (c2 > row2->begin()) *(c2 - 1) += *c1;
            if (c2 + 1 < row2->end()) *(c2 + 1) += *c1;
        }
    }

    ulong ret = 0;
    for (auto n: counts.back())
        if (n != UINT_MAX) ret += n;
    return ret;
}

int main()
{
    // std::cout << part1(sample_diagram) << std::endl;
    // std::cout << part1(diagram) << std::endl;
    std::cout << part2(sample_diagram) << std::endl;
    std::cout << part2(diagram) << std::endl;
    return 0;
}
